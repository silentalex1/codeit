local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")

local SYNC_URL = "https://codeit.rest/sync"
local EXTENSION_ID = "edfbngkhlmkolckogoigjmkellhokgeo"
local API_KEY = "YOUR_SECRET"
local POLL_INTERVAL = 0.45

local widgetInfo = DockWidgetPluginGuiInfo.new(Enum.InitialDockState.Right, true, false, 320, 500, 250, 400)
local widget = plugin:CreateDockWidgetPluginGui("CodeitCopilot", widgetInfo)
widget.Title = "Codeit Copilot"

local main = Instance.new("Frame")
main.Size = UDim2.new(1, 0, 1, 0)
main.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
main.BorderSizePixel = 0
main.Parent = widget

local header = Instance.new("Frame")
header.Size = UDim2.new(1, -20, 0, 45)
header.Position = UDim2.new(0, 10, 0, 10)
header.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
header.BorderSizePixel = 0
local hc = Instance.new("UICorner")
hc.CornerRadius = UDim.new(0, 8)
hc.Parent = header
header.Parent = main

local dot = Instance.new("Frame")
dot.Size = UDim2.new(0, 10, 0, 10)
dot.Position = UDim2.new(0, 15, 0.5, -5)
dot.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
dot.BorderSizePixel = 0
local dc = Instance.new("UICorner")
dc.CornerRadius = UDim.new(1, 0)
dc.Parent = dot
dot.Parent = header

local status = Instance.new("TextLabel")
status.Size = UDim2.new(1, -40, 1, 0)
status.Position = UDim2.new(0, 35, 0, 0)
status.BackgroundTransparency = 1
status.Text = "NOT CONNECTED"
status.TextColor3 = Color3.fromRGB(255, 60, 60)
status.Font = Enum.Font.GothamBold
status.TextSize = 13
status.TextXAlignment = Enum.TextXAlignment.Left
status.Parent = header

local box = Instance.new("ScrollingFrame")
box.Size = UDim2.new(1, -20, 0, 200)
box.Position = UDim2.new(0, 10, 0, 70)
box.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
box.BorderSizePixel = 0
box.CanvasSize = UDim2.new(0, 0, 0, 0)
box.ScrollBarThickness = 4
local bc = Instance.new("UICorner")
bc.CornerRadius = UDim.new(0, 10)
bc.Parent = box
box.Parent = main

local pText = Instance.new("TextLabel")
pText.Size = UDim2.new(1, -20, 1, -20)
pText.Position = UDim2.new(0, 10, 0, 10)
pText.BackgroundTransparency = 1
pText.Text = "Waiting for extension..."
pText.TextColor3 = Color3.fromRGB(100, 100, 100)
pText.Font = Enum.Font.Gotham
pText.TextSize = 12
pText.TextWrapped = true
pText.TextXAlignment = Enum.TextXAlignment.Left
pText.TextYAlignment = Enum.TextYAlignment.Top
pText.Parent = box

local confirm = Instance.new("TextButton")
confirm.Size = UDim2.new(1, -20, 0, 50)
confirm.Position = UDim2.new(0, 10, 0, 280)
confirm.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
confirm.Text = "APPLY UPDATE"
confirm.TextColor3 = Color3.fromRGB(120, 120, 120)
confirm.Font = Enum.Font.GothamBlack
confirm.TextSize = 15
local cc = Instance.new("UICorner")
cc.CornerRadius = UDim.new(0, 12)
cc.Parent = confirm
confirm.Parent = main

local connected = false
local lastTs = 0
local pending = nil

local function setStatus(val)
	connected = val
	status.Text = val and "CONNECTED" or "NOT CONNECTED"
	status.TextColor3 = val and Color3.fromRGB(0, 255, 136) or Color3.fromRGB(255, 60, 60)
	dot.BackgroundColor3 = val and Color3.fromRGB(0, 255, 136) or Color3.fromRGB(255, 60, 60)
	confirm.BackgroundColor3 = val and Color3.fromRGB(59, 130, 246) or Color3.fromRGB(40, 40, 40)
	confirm.TextColor3 = val and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(120, 120, 120)
end

local function pulse()
	TweenService:Create(dot, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out, 1, true), {Size = UDim2.new(0, 14, 0, 14)}):Play()
end

local ROOTS = {
	Workspace = workspace,
	ReplicatedStorage = game:GetService("ReplicatedStorage"),
	ServerScriptService = game:GetService("ServerScriptService"),
	ServerStorage = game:GetService("ServerStorage"),
	StarterGui = game:GetService("StarterGui"),
	StarterPlayer = game:GetService("StarterPlayer"),
	StarterPack = game:GetService("StarterPack"),
	SoundService = game:GetService("SoundService"),
	Lighting = game:GetService("Lighting"),
}

local function splitPath(path)
	local out = {}
	for _, p in ipairs(string.split(path, "/")) do
		if p and p ~= "" then table.insert(out, p) end
	end
	return out
end

local function resolvePath(path)
	if type(path) ~= "string" or path == "" then return nil end
	local parts = splitPath(path)
	local root = ROOTS[parts[1]]
	if not root then return nil end
	local obj = root
	for i = 2, #parts do
		obj = obj:FindFirstChild(parts[i])
		if not obj then return nil end
	end
	return obj
end

local function ensureFolder(parentObj, name)
	local f = parentObj:FindFirstChild(name)
	if f and f:IsA("Folder") then return f end
	local nf = Instance.new("Folder")
	nf.Name = name
	nf.Parent = parentObj
	return nf
end

local function ensureContainerPath(path)
	local parts = splitPath(path)
	local root = ROOTS[parts[1]]
	if not root then return nil end
	local cur = root
	for i = 2, #parts do
		cur = ensureFolder(cur, parts[i])
	end
	return cur
end

local function applyOps(ops)
	if type(ops) ~= "table" then return end
	for _, op in ipairs(ops) do
		if type(op) ~= "table" then continue end
		local t = op.type
		if t == "create_folder" then
			local parentObj = ensureContainerPath(op.parent)
			if parentObj and type(op.name) == "string" and op.name ~= "" then
				ensureFolder(parentObj, op.name)
			end
		elseif t == "create_instance" then
			local parentObj = ensureContainerPath(op.parent)
			if parentObj and type(op.class) == "string" and op.class ~= "" then
				local inst = Instance.new(op.class)
				if type(op.name) == "string" and op.name ~= "" then inst.Name = op.name end
				if type(op.props) == "table" then
					for k, v in pairs(op.props) do
						pcall(function() inst[k] = v end)
					end
				end
				inst.Parent = parentObj
			end
		elseif t == "set_script_source" then
			local obj = resolvePath(op.path)
			if obj and (obj:IsA("Script") or obj:IsA("LocalScript") or obj:IsA("ModuleScript")) and type(op.source) == "string" then
				obj.Source = op.source
			end
		elseif t == "delete" then
			local obj = resolvePath(op.path)
			if obj then obj:Destroy() end
		elseif t == "rename" then
			local obj = resolvePath(op.path)
			if obj and type(op.newName) == "string" and op.newName ~= "" then
				obj.Name = op.newName
			end
		end
	end
end

local function request(method, url, bodyTbl)
	local req = {
		Url = url,
		Method = method,
		Headers = {
			["Content-Type"] = "application/json",
			["Authorization"] = "Bearer " .. API_KEY,
			["X-Extension-Id"] = EXTENSION_ID,
		},
	}
	if bodyTbl then
		req.Body = HttpService:JSONEncode(bodyTbl)
	end
	return HttpService:RequestAsync(req)
end

confirm.MouseButton1Click:Connect(function()
	if connected and pending and pending.ops then
		applyOps(pending.ops)
		pText.Text = "Applied update lively."
		pending = nil
	end
end)

task.spawn(function()
	while true do
		local ok, res = pcall(function()
			return request("GET", SYNC_URL .. "?since=" .. tostring(lastTs), nil)
		end)

		if ok and res and res.Success and res.Body and res.Body ~= "" then
			local decodedOk, data = pcall(function()
				return HttpService:JSONDecode(res.Body)
			end)

			if decodedOk and type(data) == "table" then
				setStatus(true)
				if type(data.ts) == "number" and data.ts > lastTs then
					lastTs = data.ts
					pending = data
					pText.Text = data.prompt or "Update received."
					pulse()
				end
			else
				setStatus(false)
			end
		else
			setStatus(false)
		end

		task.wait(POLL_INTERVAL)
	end
end)

setStatus(false)
